<!DOCTYPE html>
<html>
<head>
    <title>Garage Cam</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- HLS.js for H.264 streaming -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Top Bar */
        .top-bar {
            background: #000000;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #0a0a0a;
            z-index: 100;
        }
        .top-left {
            display: flex;
            flex-direction: column;
        }
        .camera-name {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }
        .ip-address {
            font-size: 12px;
            color: #4A9EFF;
            margin-top: 2px;
        }
        .top-right {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 12px;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #888;
        }
        .status-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #0a0a0a;
        }
        .settings-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .settings-icon:hover {
            opacity: 1;
        }

        /* Main Video Area */
        .video-container {
            flex: 1;
            background: #000;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        #stream {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        video#stream {
            background: #000;
        }
        .timestamp {
            position: absolute;
            bottom: 15px;
            left: 15px;
            font-size: 14px;
            color: #fff;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 4px;
            z-index: 10;
            backdrop-filter: blur(4px);
        }

        /* Bottom Controls */
        .bottom-bar {
            background: #000000;
            padding: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            border-top: 1px solid #0a0a0a;
        }
        .control-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: #fff;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: scale(1.1);
        }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: #050505;
            box-shadow: -2px 0 20px rgba(0, 0, 0, 0.9);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .settings-panel.open {
            right: 0;
        }
        .settings-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #0a0a0a;
        }
        .settings-header h2 {
            font-size: 18px;
            color: #fff;
        }
        .close-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .settings-content {
            padding: 20px;
            flex: 1;
        }
        .settings-section {
            margin-bottom: 30px;
        }
        .settings-section h3 {
            font-size: 14px;
            color: #444;
            text-transform: uppercase;
            margin-bottom: 15px;
            letter-spacing: 1px;
            font-weight: 500;
        }

        /* Toggle Switches */
        .toggle-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px;
        }
        .toggle-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
        }
        .toggle-label {
            font-size: 14px;
            color: #fff;
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: #0a0a0a;
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
            border: 1px solid #1a1a1a;
        }
        .toggle-switch.active {
            background: #2196F3;
            border-color: #2196F3;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #fff;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }
        .toggle-switch.active::after {
            left: 26px;
        }

        /* Preset Button */
        .preset-btn {
            width: 100%;
            padding: 12px;
            background: #2196F3;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 25px;
        }
        .preset-btn:hover {
            background: #1976D2;
        }

        /* Sliders */
        .slider-group {
            margin-bottom: 20px;
        }
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
            color: #aaa;
        }
        .slider-value {
            color: #666;
        }
        input[type="range"] {
            width: 100%;
            height: 4px;
            background: #0a0a0a;
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #2196F3;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #2196F3;
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }

        select {
            width: 100%;
            padding: 8px;
            background: #0a0a0a;
            color: #fff;
            border: 1px solid #1a1a1a;
            border-radius: 4px;
            font-size: 13px;
        }

        /* System Info */
        .system-info {
            padding: 12px;
            background: #000000;
            border: 1px solid #0a0a0a;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 15px;
        }
        .system-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .system-item:last-child {
            margin-bottom: 0;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        .btn-reboot {
            padding: 12px;
            background: #F44336;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-reset {
            padding: 12px;
            background: #2196F3;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            background: #4CAF50;
        }
        .notification.info {
            background: #2196F3;
        }
        .notification.warning {
            background: #FF9800;
        }
        .notification.error {
            background: #F44336;
        }

        @media (max-width: 768px) {
            .settings-panel {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-left">
            <div class="camera-name" id="camera-name">• Garage Cam</div>
            <div class="ip-address" id="ip-address">Loading...</div>
        </div>
        <div class="top-right">
            <div class="status-item">
                <span class="status-icon"></span>
                <span id="motion-status">0 Motion</span>
            </div>
            <div class="status-item">
                <span class="status-icon"></span>
                <span id="disk-status">Loading...</span>
            </div>
            <div class="status-item">
                <span class="status-icon"></span>
                <span id="bandwidth-status">0 Kbps</span>
            </div>
            <svg class="settings-icon" onclick="toggleSettings()" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6m9-9h-6m-6 0H3m15.364 6.364l-4.243-4.243m-4.242 0L5.636 17.364m12.728 0l-4.243-4.243m-4.242 0L5.636 6.636"></path>
            </svg>
        </div>
    </div>

    <!-- Main Video Area -->
    <div class="video-container">
        <div class="timestamp" id="timestamp"></div>
        <video id="stream" autoplay muted playsinline></video>
    </div>

    <!-- Bottom Controls -->
    <div class="bottom-bar">
        <button class="control-btn" onclick="togglePlayPause()" id="play-pause-btn" title="Play/Pause">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        </button>
        <button class="control-btn" onclick="stopStream()" title="Stop Stream">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M6 6h12v12H6z"/></svg>
        </button>
        <button class="control-btn" onclick="takeSnapshot()" title="Take Picture">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                <path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
                <circle cx="12" cy="12" r="3.2"/>
            </svg>
        </button>
        <button class="control-btn" onclick="toggleFullscreen()" title="Fullscreen">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
        </button>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settings-panel">
        <div class="settings-header">
            <h2>Settings</h2>
            <button class="close-btn" onclick="toggleSettings()">×</button>
        </div>
        <div class="settings-content">
            <!-- Feature Toggles -->
            <div class="toggle-group">
                <div class="toggle-item">
                    <span class="toggle-label">Motion Detection</span>
                    <div class="toggle-switch" onclick="toggleSwitch(this, 'motion')"></div>
                </div>
            </div>

            <!-- Video Settings -->
            <div class="settings-section">
                <h3>VIDEO</h3>
                
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Digital Zoom</span>
                        <span class="slider-value" id="zoom_val">1.0</span>x
                    </div>
                    <input type="range" id="zoom" min="1.0" max="4.0" value="1.0" step="0.1" oninput="updateSlider('zoom', this.value)">
                </div>

                <div class="slider-group">
                    <div class="slider-label">
                        <span>Resolution</span>
                    </div>
                    <select id="resolution" onchange="applyResolution()">
                        <option value="1920x1080">1920x1080 (Full HD - 1080p)</option>
                        <option value="1280x720">1280x720 (HD - 720p)</option>
                        <option value="640x480">640x480 (VGA)</option>
                        <option value="320x240" selected>320x240 (QVGA)</option>
                    </select>
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Framerate</span>
                        <span class="slider-value" id="framerate_val">5</span> fps
                    </div>
                    <input type="range" id="framerate" min="3" max="15" value="5" step="1" oninput="updateSlider('framerate', this.value)">
                </div>
            </div>

            <!-- Presets -->
            <button class="preset-btn" onclick="applyDaytimePreset()" style="background: #FFC107;">Daytime Preset</button>
            <button class="preset-btn" onclick="applyDarkModePreset()" style="margin-top: 10px;">Dark Mode Preset</button>
            <button class="preset-btn" onclick="applyPerformancePreset()" style="background: #FF9800; margin-top: 10px;">Performance Mode</button>

            <!-- DARK ROOM TUNING -->
            <div class="settings-section">
                <h3>DARK ROOM TUNING</h3>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Gain (0-6)</span>
                        <span class="slider-value" id="gain_val">0</span>
                    </div>
                    <input type="range" id="gain" min="0" max="6" value="0" step="0.1" oninput="updateSlider('gain', this.value)">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Exposure (0-1200)</span>
                        <span class="slider-value" id="shutter_val">0</span>
                    </div>
                    <input type="range" id="shutter" min="0" max="1200" value="0" step="10" oninput="updateSlider('shutter', this.value)">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Contrast (-2 to 2)</span>
                        <span class="slider-value" id="contrast_val">0</span>
                    </div>
                    <input type="range" id="contrast" min="-2" max="2" value="0" step="0.1" oninput="updateSlider('contrast', this.value)">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Saturation (-2 to 2)</span>
                        <span class="slider-value" id="saturation_val">0</span>
                    </div>
                    <input type="range" id="saturation" min="-2" max="2" value="0" step="0.1" oninput="updateSlider('saturation', this.value)">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Sharpness (0-16)</span>
                        <span class="slider-value" id="sharpness_val">1.0</span>
                    </div>
                    <input type="range" id="sharpness" min="0" max="16" value="1" step="0.5" oninput="updateSlider('sharpness', this.value)">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>EV Compensation (-10 to 10)</span>
                        <span class="slider-value" id="ev_val">0</span>
                    </div>
                    <input type="range" id="ev" min="-10" max="10" value="0" step="0.5" oninput="updateSlider('ev', this.value)">
                </div>
            </div>

            <!-- ADVANCED -->
            <div class="settings-section">
                <h3>ADVANCED</h3>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Denoise</span>
                    </div>
                    <select id="denoise" onchange="applyDropdown('denoise', this.value)">
                        <option value="auto" selected>Auto</option>
                        <option value="off">Off</option>
                        <option value="cdn_off">CDN Off</option>
                        <option value="cdn_fast">CDN Fast</option>
                        <option value="cdn_hq">CDN High Quality</option>
                    </select>
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>HDR Mode</span>
                    </div>
                    <select id="hdr" onchange="applyDropdown('hdr', this.value)">
                        <option value="off" selected>Off</option>
                        <option value="auto">Auto</option>
                        <option value="sensor">Sensor</option>
                        <option value="single-exp">Single Exposure</option>
                    </select>
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>JPEG Quality</span>
                        <span class="slider-value" id="quality_val">93</span>%
                    </div>
                    <input type="range" id="quality" min="1" max="100" value="93" step="1" oninput="updateSlider('quality', this.value)">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Snapshot Quality</span>
                        <span class="slider-value" id="snapshot_quality_val">100</span>%
                    </div>
                    <input type="range" id="snapshot_quality" min="80" max="100" value="100" step="5" oninput="updateSlider('snapshot_quality', this.value)">
                </div>
            </div>

            <!-- IMAGE -->
            <div class="settings-section">
                <h3>IMAGE</h3>
                <div class="toggle-group">
                    <div class="toggle-item">
                        <span class="toggle-label">Auto Exposure</span>
                        <div class="toggle-switch active" onclick="toggleSwitch(this, 'auto_exposure')"></div>
                    </div>
                    <div class="toggle-item">
                        <span class="toggle-label">Auto White Balance</span>
                        <div class="toggle-switch active" onclick="toggleSwitch(this, 'auto_wb')"></div>
                    </div>
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Brightness</span>
                        <span class="slider-value" id="brightness_val">0</span>
                    </div>
                    <input type="range" id="brightness" min="-1" max="1" value="0" step="0.1" oninput="updateSlider('brightness', this.value)">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Exposure Mode</span>
                    </div>
                    <select id="exposure" onchange="applyDropdown('exposure', this.value)">
                        <option value="normal" selected>Normal</option>
                        <option value="sport">Sport</option>
                    </select>
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Metering</span>
                    </div>
                    <select id="metering" onchange="applyDropdown('metering', this.value)">
                        <option value="centre" selected>Centre</option>
                        <option value="spot">Spot</option>
                        <option value="average">Average</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>White Balance</span>
                    </div>
                    <select id="awb" onchange="applyDropdown('awb', this.value)">
                        <option value="auto" selected>Auto</option>
                        <option value="incandescent">Incandescent</option>
                        <option value="tungsten">Tungsten</option>
                        <option value="fluorescent">Fluorescent</option>
                        <option value="indoor">Indoor</option>
                        <option value="daylight">Daylight</option>
                        <option value="cloudy">Cloudy</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Rotation</span>
                    </div>
                    <select id="rotation" onchange="applyDropdown('rotation', this.value)">
                        <option value="0" selected>0°</option>
                        <option value="90">90°</option>
                        <option value="180">180°</option>
                        <option value="270">270°</option>
                    </select>
                </div>
                <div class="toggle-group">
                    <div class="toggle-item">
                        <span class="toggle-label">V-Flip</span>
                        <div class="toggle-switch" onclick="toggleSwitch(this, 'vflip')"></div>
                    </div>
                    <div class="toggle-item">
                        <span class="toggle-label">H-Mirror</span>
                        <div class="toggle-switch" onclick="toggleSwitch(this, 'hflip')"></div>
                    </div>
                </div>
            </div>

            <!-- SYSTEM -->
            <div class="settings-section">
                <h3>SYSTEM</h3>
                <div class="slider-group" style="margin-bottom: 15px;">
                    <div class="slider-label">
                        <span>Camera Name</span>
                    </div>
                    <input type="text" id="camera_name_input" placeholder="Enter camera name" style="width: 100%; padding: 8px; background: #0a0a0a; color: #fff; border: 1px solid #1a1a1a; border-radius: 4px; font-size: 13px;" onchange="applyCameraName()">
                </div>
                <div class="system-info">
                    <div class="system-item">
                        <span>IP Address:</span>
                        <span id="system-ip">Loading...</span>
                    </div>
                    <div class="system-item">
                        <span>SD Card:</span>
                        <span id="system-disk">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn-reset" onclick="resetCameraSettings()">Reset Camera Settings</button>
                <button class="btn-reboot" onclick="rebootDevice()">Reboot Device</button>
            </div>
        </div>
    </div>

    <script>
        const ICONS = {
            play: '<svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>',
            pause: '<svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>'
        };

        let isPlaying = true;
        let settingsOpen = false;
        let isLoadingSettings = false;  // Flag to prevent applying settings during page load
        let settingsDebounceTimer = null;  // Timer for debouncing setting changes
        let hls = null;  // HLS.js instance

        // Initialize HLS video stream
        function initHLSStream() {
            const video = document.getElementById('stream');
            // Add timestamp to bust cache
            const hlsUrl = '/hls/stream.m3u8?t=' + new Date().getTime();
            
            if (Hls.isSupported()) {
                hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: true,
                    backBufferLength: 10,
                    maxBufferLength: 20,
                    maxMaxBufferLength: 30,
                    // Latency tuning
                    liveSyncDurationCount: 2, // Aim for ~4s latency (2 segments)
                    liveMaxLatencyDurationCount: 5, // Jump to live if >10s behind
                    maxLiveSyncPlaybackRate: 1.2, // Speed up slightly to catch up
                    manifestLoadingTimeOut: 10000,
                    manifestLoadingMaxRetry: 10,
                    manifestLoadingRetryDelay: 1000,
                    levelLoadingTimeOut: 10000,
                    levelLoadingMaxRetry: 10,
                    levelLoadingRetryDelay: 1000
                });
                
                hls.loadSource(hlsUrl);
                hls.attachMedia(video);
                
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    video.play().catch(e => {
                        console.log('Autoplay failed, user interaction required');
                    });
                });
                
                hls.on(Hls.Events.ERROR, function (event, data) {
                    if (data.fatal) {
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                console.log('Network error, retrying in 2 seconds...');
                                setTimeout(() => {
                                    hls.destroy();
                                    setTimeout(initHLSStream, 500);
                                }, 2000);
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                console.log('Media error, trying to recover...');
                                hls.recoverMediaError();
                                break;
                            default:
                                console.log('Fatal error, retrying in 3 seconds...');
                                hls.destroy();
                                setTimeout(initHLSStream, 3000);
                                break;
                        }
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Native HLS support (Safari, iOS)
                video.src = hlsUrl;
                video.addEventListener('loadedmetadata', function() {
                    video.play();
                });
                video.addEventListener('error', function() {
                    console.log('Video error, retrying in 3 seconds...');
                    setTimeout(initHLSStream, 3000);
                });
            }
        }

        // Reload stream with proper cleanup
        function reloadStream() {
            const video = document.getElementById('stream');
            
            // Destroy existing HLS instance
            if (hls) {
                hls.destroy();
                hls = null;
            }
            
            // Clear video source
            video.src = '';
            video.load();
            
            // Reinitialize after a longer delay to allow camera restart
            setTimeout(initHLSStream, 1000);
        }

        // Load system info on page load
        window.onload = function() {
            initHLSStream();  // Initialize HLS stream
            loadSystemInfo();
            updateTimestamp();
            setInterval(updateTimestamp, 1000);
            loadSettings();
        };

        function loadSystemInfo() {
            fetch('/system_info')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('ip-address').textContent = data.ip;
                    document.getElementById('system-ip').textContent = data.ip;
                    document.getElementById('disk-status').textContent = data.disk;
                    document.getElementById('system-disk').textContent = data.disk;
                    document.getElementById('bandwidth-status').textContent = (data.bandwidth || 0).toFixed(2) + ' Kbps';
                });
        }

        function updateTimestamp() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const ampm = now.getHours() >= 12 ? 'pm' : 'am';
            document.getElementById('timestamp').textContent = `${year}/${month}/${day} ${hours}:${minutes}:${seconds} ${ampm}`;
        }

        function toggleSettings() {
            settingsOpen = !settingsOpen;
            document.getElementById('settings-panel').classList.toggle('open', settingsOpen);
        }

        function togglePlayPause() {
            isPlaying = !isPlaying;
            const btn = document.getElementById('play-pause-btn');
            const video = document.getElementById('stream');
            if (isPlaying) {
                // If stream was fully stopped (src removed), re-init
                if (!video.src && !hls) {
                    initHLSStream();
                } else {
                    btn.innerHTML = ICONS.pause;
                    if (hls) hls.startLoad();
                    video.play();
                }
            } else {
                btn.innerHTML = ICONS.play;
                video.pause();
            }
        }

        function stopStream() {
            if (hls) {
                hls.stopLoad();
                hls.destroy();
                hls = null;
            }
            const video = document.getElementById('stream');
            video.pause();
            video.src = ''; // Clear source to make it black/empty
            video.load();   // Force clear
            
            isPlaying = false;
            document.getElementById('play-pause-btn').innerHTML = ICONS.play;
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function toggleSwitch(element, setting) {
            console.log('toggleSwitch called with', setting, element);
            element.classList.toggle('active');
            const isActive = element.classList.contains('active');
            console.log('isActive:', isActive);
            
            // Handle different toggle types
            if (setting === 'vflip' || setting === 'hflip') {
                applySetting(setting, isActive);
            } else if (setting === 'auto_exposure') {
                applyDropdown('exposure', isActive ? 'normal' : 'sport');
            } else if (setting === 'auto_wb') {
                applyDropdown('awb', isActive ? 'auto' : 'daylight');
            } else if (setting === 'motion') {
                // Not implemented yet - just visual feedback
                showNotification('Motion detection feature coming soon', 'info');
            }
        }

        function updateSlider(id, value) {
            const valueEl = document.getElementById(id + '_val');
            if (valueEl) {
                // Format display value
                if (id === 'quality' || id === 'snapshot_quality') {
                    valueEl.textContent = value + '%';
                } else if (id === 'framerate') {
                    valueEl.textContent = value;
                } else {
                    valueEl.textContent = value;
                }
            }

            // Don't apply settings if we're just loading them from the server
            if (isLoadingSettings) {
                return;
            }

            // Apply setting immediately
            const settingMap = {
                'zoom': 'zoom',
                'gain': 'gain',
                'shutter': 'shutter',
                'contrast': 'contrast',
                'saturation': 'saturation',
                'brightness': 'brightness',
                'sharpness': 'sharpness',
                'ev': 'ev',
                'framerate': 'framerate',
                'quality': 'quality',
                'snapshot_quality': 'snapshot_quality'
            };

            if (settingMap[id]) {
                applySetting(settingMap[id], parseFloat(value));
            }
        }

        function applySetting(key, value) {
            console.log('applySetting called:', key, value);
            // Cancel any pending setting update
            if (settingsDebounceTimer) {
                clearTimeout(settingsDebounceTimer);
            }

            // Wait 800ms after last change before applying
            settingsDebounceTimer = setTimeout(() => {
                console.log('applySetting timeout fired, sending to backend');
                const settings = {};

                // Convert UI values to backend format
                if (key === 'shutter') {
                    // UI shows 0-1200 scale (likely milliseconds), convert to microseconds
                    // Map 0-1200 range to 0-1200000 microseconds (0 to 1.2 seconds)
                    settings[key] = Math.round(value * 1000);
                } else {
                    settings[key] = value;
                }

                console.log('Sending fetch request:', settings);
                fetch('/apply', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                }).then(response => {
                    console.log('Apply response status:', response.status);
                    return response.json();
                }).then(data => {
                    console.log('Apply response data:', data);
                    // Settings applied
                    if (key === 'vflip' || key === 'hflip') {
                        // These settings require camera restart, so reload the stream
                        console.log('Flip setting changed, reloading stream in 2 seconds');
                        setTimeout(reloadStream, 2000);  // Wait 2 seconds for camera to restart
                    }
                    // No need to reload stream for other settings
                }).catch(error => {
                    console.error('Apply setting failed:', error);
                    showNotification('Failed to apply setting: ' + error.message, 'error');
                });
            }, 800);
        }

        function applyDropdown(key, value) {
            // Cancel any pending setting update
            if (settingsDebounceTimer) {
                clearTimeout(settingsDebounceTimer);
            }

            // Dropdowns don't need as much delay (immediate selection)
            settingsDebounceTimer = setTimeout(() => {
                const settings = {};
                if (key === 'rotation') {
                    settings[key] = parseInt(value);
                } else {
                    settings[key] = value;
                }

                fetch('/apply', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                }).then(() => {
                    // Settings applied - no need to reload stream
                    // Camera updates settings without restarting
                });
            }, 300);  // Shorter delay for dropdowns
        }

        function applyResolution() {
            // Stop stream immediately to prevent 404s and race conditions
            stopStream();

            const res = document.getElementById('resolution').value.split('x');
            const settings = {
                width: parseInt(res[0]),
                height: parseInt(res[1])
            };

            showNotification(`Changing resolution to ${res[0]}x${res[1]}...`, 'info');

            fetch('/apply', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(settings)
            }).then(() => {
                showNotification(`Resolution changed`, 'success');
                // Wait for camera/ffmpeg to restart and create initial segments
                // Needs about 2s for startup + 2s for first segment
                setTimeout(() => {
                    initHLSStream();
                }, 4000); 
            });
        }

        function takeSnapshot() {
            const snapshotBtn = event.target.closest('button');
            const originalOpacity = snapshotBtn.style.opacity;
            
            // Visual feedback: reduce opacity during capture
            snapshotBtn.disabled = true;
            snapshotBtn.style.opacity = '0.6';
            snapshotBtn.title = 'Taking photo...';
            
            console.log('Snapshot: Sending POST request...');
            
            fetch('/snapshot', {method: 'POST'})
                .then(r => {
                    console.log('Snapshot: Received response, status:', r.status);
                    return r.json();
                })
                .then(data => {
                    console.log('Snapshot: Response data:', data);
                    snapshotBtn.style.opacity = originalOpacity || '1';
                    snapshotBtn.disabled = false;
                    snapshotBtn.title = 'Take Picture';
                    
                    if (data.success) {
                        console.log('Snapshot: Success! Downloading:', data.filename);
                        showNotification('Picture saved: ' + data.filename, 'success');
                        
                        // Download the file
                        const link = document.createElement('a');
                        link.href = data.url;
                        link.download = data.filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    } else {
                        console.error('Snapshot: Failed -', data.error);
                        showNotification('Snapshot failed: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Snapshot: Fetch error -', error);
                    snapshotBtn.style.opacity = originalOpacity || '1';
                    snapshotBtn.disabled = false;
                    snapshotBtn.title = 'Take Picture';
                    showNotification('Snapshot error: ' + error, 'error');
                });
        }

        function applyDaytimePreset() {
            // Stop stream first to prevent errors
            stopStream();
            
            // Apply daytime optimized settings (no HDR - causes crashes on Pi Zero)
            const presetSettings = {
                gain: 0,           // Auto gain (plenty of light)
                shutter: 0,        // Auto shutter (fast for bright conditions)
                contrast: 1.2,     // Slightly higher for vibrant colors
                saturation: 1.2,   // Slightly higher for vivid daytime colors
                brightness: 0,     // Normal brightness
                hdr: 'off',        // HDR off (causes device timeout on Pi Zero 2W)
                exposure: 'normal',
                denoise: 'auto'    // Auto denoise
            };

            fetch('/apply', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(presetSettings)
            }).then(() => {
                // Update UI controls
                document.getElementById('gain').value = 0;
                document.getElementById('shutter').value = 0;
                document.getElementById('contrast').value = 1.2;
                document.getElementById('saturation').value = 1.2;
                document.getElementById('brightness').value = 0;
                document.getElementById('hdr').value = 'off';
                document.getElementById('exposure').value = 'normal';
                document.getElementById('denoise').value = 'auto';

                updateSlider('gain', 0);
                updateSlider('shutter', 0);
                updateSlider('contrast', 1.2);
                updateSlider('saturation', 1.2);
                updateSlider('brightness', 0);

                showNotification('Daytime Preset Applied', 'success');
                
                // Restart stream after delay
                setTimeout(() => {
                    initHLSStream();
                }, 3000);
            });
        }

        function applyDarkModePreset() {
            // Apply dark room optimized settings - send all at once
            const presetSettings = {
                gain: 2.0,
                shutter: 200000,  // 200ms in microseconds
                contrast: 0.5
            };

            fetch('/apply', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(presetSettings)
            }).then(() => {
                // Update UI sliders
                document.getElementById('gain').value = 2;
                document.getElementById('shutter').value = 200;  // UI shows 0-1200 scale
                document.getElementById('contrast').value = 0.5;
                updateSlider('gain', 2);
                updateSlider('shutter', 200);
                updateSlider('contrast', 0.5);

                showNotification('Dark Mode Preset Applied', 'success');
            });
        }

        function applyPerformancePreset() {
            // Apply CPU-efficient settings for low resource usage
            const presetSettings = {
                width: 640,
                height: 480,
                framerate: 10,
                quality: 40,
                denoise: 'off',  // Disable denoise to save CPU
                hdr: 'off'       // Disable HDR to save CPU
            };

            fetch('/apply', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(presetSettings)
            }).then(() => {
                // Update UI controls
                document.getElementById('resolution').value = '640x480';
                document.getElementById('framerate').value = 10;
                document.getElementById('quality').value = 40;
                document.getElementById('denoise').value = 'off';
                document.getElementById('hdr').value = 'off';
                updateSlider('framerate', 10);
                updateSlider('quality', 40);

                showNotification('Performance Mode Applied - Lower CPU usage', 'success');
                // Wait for camera to restart before reloading feed
                setTimeout(() => {
                    reloadStream();
                }, 800);
            });
        }

        function rebootDevice() {
            if (confirm('Restart the camera service? The stream will be temporarily unavailable.')) {
                // Show full-screen reboot overlay
                const overlay = document.createElement('div');
                overlay.id = 'reboot-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.95);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;
                
                const message = document.createElement('div');
                message.style.cssText = `
                    color: #fff;
                    font-size: 32px;
                    font-weight: bold;
                    text-align: center;
                    text-transform: uppercase;
                    letter-spacing: 2px;
                `;
                message.textContent = 'Rebooting...';
                
                overlay.appendChild(message);
                document.body.appendChild(overlay);
                
                // Send restart request
                fetch('/restart_service', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                }).then(response => response.json()).then(data => {
                    if (data.status === 'ok') {
                        message.textContent = 'Rebooting... Please wait';
                        // Wait for service to restart
                        setTimeout(() => {
                            location.reload();
                        }, 3000);
                    } else {
                        overlay.remove();
                        showNotification('Failed to restart service: ' + (data.error || 'Unknown error'), 'error');
                    }
                }).catch(error => {
                    overlay.remove();
                    showNotification('Restart failed: ' + error.message, 'error');
                    console.error('Reboot error:', error);
                });
            }
        }

        function resetCameraSettings() {
            if (confirm('Reset all camera settings to defaults? This will save defaults to disk and reload the page.')) {
                fetch('/reset', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                }).then(response => response.json()).then(data => {
                    showNotification('Settings reset to defaults', 'success');
                    // Wait a moment before reloading to ensure settings are saved
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }).catch(error => {
                    showNotification('Failed to reset settings', 'error');
                    console.error('Reset error:', error);
                });
            }
        }

        function loadSettings() {
            isLoadingSettings = true;  // Set flag to prevent applying settings during load
            fetch('/settings')
                .then(r => r.json())
                .then(settings => {
                    // Load camera name
                    if (settings.camera_name) {
                        document.getElementById('camera_name_input').value = settings.camera_name;
                        document.getElementById('camera-name').textContent = '• ' + settings.camera_name;
                    }

                    // Set Resolution Dropdown
                    if (settings.width && settings.height) {
                        const resString = `${settings.width}x${settings.height}`;
                        const resolutionSelect = document.getElementById('resolution');
                        if (resolutionSelect) {
                            resolutionSelect.value = resString;
                        }
                    }

                    // Apply loaded settings to UI
                    const vflipToggle = document.querySelector('[onclick*="vflip"]');
                    const hflipToggle = document.querySelector('[onclick*="hflip"]');
                    const expToggle = document.querySelector('[onclick*="auto_exposure"]');
                    const awbToggle = document.querySelector('[onclick*="auto_wb"]');

                    if (settings.vflip && vflipToggle) vflipToggle.classList.add('active');
                    if (settings.hflip && hflipToggle) hflipToggle.classList.add('active');
                    if (settings.exposure === 'normal' && expToggle) expToggle.classList.add('active');
                    if (settings.awb === 'auto' && awbToggle) awbToggle.classList.add('active');

                    document.getElementById('gain').value = settings.gain || 0;
                    // Convert shutter from microseconds to UI scale (0-1200)
                    const shutterUi = settings.shutter ? Math.round(settings.shutter / 1000) : 0;
                    document.getElementById('shutter').value = Math.min(shutterUi, 1200);
                    document.getElementById('contrast').value = settings.contrast || 0;
                    document.getElementById('saturation').value = settings.saturation || 0;
                    document.getElementById('brightness').value = settings.brightness || 0;
                    document.getElementById('zoom').value = settings.zoom || 1.0;
                    document.getElementById('framerate').value = settings.framerate || 15;
                    document.getElementById('sharpness').value = settings.sharpness || 1.0;
                    document.getElementById('ev').value = settings.ev || 0;
                    document.getElementById('quality').value = settings.quality || 93;
                    document.getElementById('snapshot_quality').value = settings.snapshot_quality || 100;

                    updateSlider('gain', settings.gain || 0);
                    updateSlider('shutter', document.getElementById('shutter').value);
                    updateSlider('contrast', settings.contrast || 0);
                    updateSlider('saturation', settings.saturation || 0);
                    updateSlider('brightness', settings.brightness || 0);
                    updateSlider('zoom', settings.zoom || 1.0);
                    updateSlider('framerate', settings.framerate || 15);
                    updateSlider('sharpness', settings.sharpness || 1.0);
                    updateSlider('ev', settings.ev || 0);
                    updateSlider('quality', settings.quality || 93);
                    updateSlider('snapshot_quality', settings.snapshot_quality || 100);

                    // Load dropdowns
                    if (settings.denoise) document.getElementById('denoise').value = settings.denoise;
                    if (settings.hdr) document.getElementById('hdr').value = settings.hdr;
                    if (settings.exposure) document.getElementById('exposure').value = settings.exposure;
                    if (settings.metering) document.getElementById('metering').value = settings.metering;
                    if (settings.awb) document.getElementById('awb').value = settings.awb;
                    if (settings.rotation) document.getElementById('rotation').value = settings.rotation;

                    isLoadingSettings = false;  // Reset flag after loading
                });
        }

        function applyCameraName() {
            const cameraName = document.getElementById('camera_name_input').value;
            if (!cameraName || cameraName.trim() === '') {
                showNotification('Camera name cannot be empty', 'warning');
                return;
            }

            fetch('/apply', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ camera_name: cameraName })
            }).then(response => response.json()).then(data => {
                // Update the display
                document.getElementById('camera-name').textContent = '• ' + cameraName;
                showNotification('Camera name updated', 'success');
            }).catch(error => {
                showNotification('Failed to update camera name', 'error');
                console.error('Camera name update error:', error);
            });
        }

        function showNotification(message, type) {
            // Remove existing notifications to prevent stacking
            const existing = document.querySelectorAll('.notification');
            existing.forEach(e => e.remove());

            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.classList.add('show'), 10);
            setTimeout(() => {
                notif.classList.remove('show');
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', e => {
            if (e.key === 'f' || e.key === 'F') toggleFullscreen();
            if (e.key === 'Escape' && settingsOpen) toggleSettings();
        });
    </script>
</body>
</html>
'''
