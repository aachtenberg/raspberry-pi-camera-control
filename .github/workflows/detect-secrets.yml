name: Detect Secrets

on:
  push:
    branches: [ master ]
  pull_request:

jobs:
  detect-secrets:
    name: Detect potential secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install detect-secrets
        run: |
          python -m pip install --upgrade pip
          pip install detect-secrets

      - name: Run detect-secrets scan and compare to baseline
        run: |
          set -e
          detect-secrets scan --all-files > .secrets.baseline.new
          # If baseline file doesn't exist, fail so maintainers can add one explicitly
          if [ ! -f .secrets.baseline ]; then
            echo ".secrets.baseline not found in repo. Please generate and commit a baseline." >&2
            exit 2
          fi

          # Show diff and fail if new findings are present
          if ! git --no-pager diff --no-ext-diff --exit-code -- .secrets.baseline .secrets.baseline.new; then
            echo "New potential secrets detected!" >&2
            echo "Run: detect-secrets scan --all-files > .secrets.baseline.new && detect-secrets audit .secrets.baseline.new" >&2
            echo "If findings are intentional, audit them and update .secrets.baseline accordingly." >&2
            echo
            echo "Diff (baseline -> new):" >&2
            git --no-pager diff --no-ext-diff .secrets.baseline .secrets.baseline.new || true
            exit 1
          fi

      - name: Cleanup
        run: |
          rm -f .secrets.baseline.new
